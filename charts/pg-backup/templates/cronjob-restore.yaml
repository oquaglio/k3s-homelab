apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "pg-backup.fullname" . }}-restore
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pg-backup.labels" . | nindent 4 }}
spec:
  # Suspended - never runs on schedule. Triggered manually via:
  #   kubectl create job <name> --from=cronjob/{{ include "pg-backup.fullname" . }}-restore -n {{ .Release.Namespace }}
  schedule: "0 0 1 1 *"
  suspend: true
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1
      template:
        metadata:
          labels:
            {{- include "pg-backup.selectorLabels" . | nindent 12 }}
            component: restore
        spec:
          restartPolicy: Never
          containers:
            - name: pg-restore
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy }}
              command: ["bash", "/scripts/restore.sh"]
              env:
                - name: PG_HOST
                  value: {{ .Values.postgresql.host | quote }}
                - name: PG_PORT
                  value: {{ .Values.postgresql.port | quote }}
                - name: PG_DATABASE
                  value: {{ .Values.postgresql.database | quote }}
                - name: PG_USER
                  value: {{ .Values.postgresql.username | quote }}
                - name: PG_PASSWORD
                  value: {{ .Values.postgresql.password | quote }}
                - name: S3_ENDPOINT
                  value: {{ .Values.s3.endpoint | quote }}
                - name: S3_BUCKET
                  value: {{ .Values.s3.bucket | quote }}
                - name: S3_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "pg-backup.fullname" . }}-s3
                      key: s3-access-key
                - name: S3_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ include "pg-backup.fullname" . }}-s3
                      key: s3-secret-key
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
              resources:
                requests:
                  memory: {{ .Values.resources.requests.memory | quote }}
                  cpu: {{ .Values.resources.requests.cpu | quote }}
                limits:
                  memory: {{ .Values.resources.limits.memory | quote }}
                  cpu: {{ .Values.resources.limits.cpu | quote }}
          volumes:
            - name: scripts
              configMap:
                name: {{ include "pg-backup.fullname" . }}-scripts
                defaultMode: 0755
