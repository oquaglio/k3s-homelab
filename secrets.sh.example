#!/bin/bash
# secrets.sh.example - Template for creating K8s secrets
# Copy this file to secrets.sh and customize it
# DO NOT commit secrets.sh to git!

set -e

echo "========================================="
echo "Creating K8s Secrets"
echo "========================================="
echo ""

export KUBECONFIG=~/.kube/config

# Check if htpasswd is installed
if ! command -v htpasswd &> /dev/null; then
    echo "Installing htpasswd..."
    sudo dnf install -y httpd-tools
fi

# Create namespaces if they don't exist
echo "Ensuring namespaces exist..."
kubectl create namespace portainer --dry-run=client -o yaml | kubectl apply -f -
kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
echo ""

# ========================================
# Portainer Admin Password
# ========================================
echo "Setting up Portainer password..."

# Change these values!
PORTAINER_USERNAME="admin"
PORTAINER_PASSWORD="changeme123"  # CHANGE THIS!

# Generate bcrypt hash
PORTAINER_HASHED_PASSWORD=$(htpasswd -nbB $PORTAINER_USERNAME "$PORTAINER_PASSWORD" | cut -d ':' -f2)

# Create secret
kubectl create secret generic portainer-admin-password \
  --from-literal=password="$PORTAINER_HASHED_PASSWORD" \
  -n portainer \
  --dry-run=client -o yaml | kubectl apply -f -

echo "✓ Portainer password secret created"
echo ""

# ========================================
# Grafana Admin Password
# ========================================
echo "Setting up Grafana password..."

# Change this value!
GRAFANA_PASSWORD="admin"  # CHANGE THIS!

# Create secret
kubectl create secret generic kube-prometheus-stack-grafana \
  --from-literal=admin-user=admin \
  --from-literal=admin-password="$GRAFANA_PASSWORD" \
  -n monitoring \
  --dry-run=client -o yaml | kubectl apply -f -

echo "✓ Grafana password secret created"
echo ""

# ========================================
# Summary
# ========================================
echo "========================================="
echo "Secrets created successfully!"
echo "========================================="
echo ""
echo "Credentials:"
echo "  Portainer:  $PORTAINER_USERNAME / $PORTAINER_PASSWORD"
echo "  Grafana:    admin / $GRAFANA_PASSWORD"
echo ""
echo "IMPORTANT: Change the passwords in this script before running!"
echo "IMPORTANT: Do not commit secrets.sh to git!"
